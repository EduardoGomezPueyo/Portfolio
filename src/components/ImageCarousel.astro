---
interface Props {
  images: { src: string; alt: string }[];
  caption?: string;
}

const { images, caption } = Astro.props;
---

<figure class="not-prose my-12">
  <div
    class="group relative overflow-hidden rounded-lg bg-neutral-100 dark:bg-neutral-900"
    data-carousel
  >
    <div class="flex transition-transform duration-300 ease-in-out" data-carousel-track>
      {images.map((image) => (
        <div class="w-full shrink-0">
          <img
            src={image.src}
            alt={image.alt}
            class="block w-full h-auto"
            loading="lazy"
          />
        </div>
      ))}
    </div>

    {images.length > 1 && (
      <>
        <button
          type="button"
          data-carousel-prev
          class="absolute left-3 top-1/2 -translate-y-1/2 rounded-full bg-white/80 dark:bg-neutral-800/80 p-2 opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity shadow-md backdrop-blur-sm"
          aria-label="Previous image"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-700 dark:text-neutral-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
        </button>

        <button
          type="button"
          data-carousel-next
          class="absolute right-3 top-1/2 -translate-y-1/2 rounded-full bg-white/80 dark:bg-neutral-800/80 p-2 opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity shadow-md backdrop-blur-sm"
          aria-label="Next image"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-700 dark:text-neutral-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2" data-carousel-dots>
          {images.map((_, i) => (
            <button
              type="button"
              data-carousel-dot={i}
              class:list={[
                'h-2 w-2 rounded-full transition-colors',
                i === 0
                  ? 'bg-white dark:bg-neutral-200'
                  : 'bg-white/50 dark:bg-neutral-400/50',
              ]}
              aria-label={`Go to image ${i + 1}`}
            />
          ))}
        </div>
      </>
    )}
  </div>

  {caption && (
    <figcaption class="mt-3 text-sm text-neutral-500 dark:text-neutral-400 text-center">
      {caption}
    </figcaption>
  )}
</figure>

<script>
  function initCarousels() {
    document.querySelectorAll<HTMLElement>('[data-carousel]').forEach((carousel) => {
      if (carousel.dataset.initialized) return;
      carousel.dataset.initialized = 'true';
    const track = carousel.querySelector<HTMLElement>('[data-carousel-track]')!;
    const dots = carousel.querySelectorAll<HTMLButtonElement>('[data-carousel-dot]');
    const prevBtn = carousel.querySelector<HTMLButtonElement>('[data-carousel-prev]');
    const nextBtn = carousel.querySelector<HTMLButtonElement>('[data-carousel-next]');
    const total = dots.length || 1;
    let current = 0;

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) {
      track.style.transitionDuration = '0s';
    }

    function goTo(index: number) {
      current = (index + total) % total;
      track.style.transform = `translateX(-${current * 100}%)`;
      dots.forEach((dot, i) => {
        dot.classList.toggle('bg-white', i === current);
        dot.classList.toggle('dark:bg-neutral-200', i === current);
        dot.classList.toggle('bg-white/50', i !== current);
        dot.classList.toggle('dark:bg-neutral-400/50', i !== current);
      });
    }

    prevBtn?.addEventListener('click', () => goTo(current - 1));
    nextBtn?.addEventListener('click', () => goTo(current + 1));
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        goTo(Number(dot.dataset.carouselDot));
      });
    });

    carousel.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') goTo(current - 1);
      if (e.key === 'ArrowRight') goTo(current + 1);
    });
  });
  }

  document.addEventListener('astro:page-load', initCarousels);
</script>
